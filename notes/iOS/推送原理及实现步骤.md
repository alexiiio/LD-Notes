# 推送原理

推送功能是基于长连接的基础上实现的。因为推送是由服务器主动向客户端发送消息，如果客户端和服务器之间不存在一个长连接那么服务器是无法来主动连接客户端的。

在iOS系统上，由苹果维护了一个客户端和苹果服务器的长链接，iOS上的所有应用上的推送都是先将消息推送到苹果的服务器然后苹果服务器通过这个系统级别的长连接推送到手机终端上，这样的的几个好处为：

- 在手机终端始终只要维护一个长连接即可，而且由于这个长连接是系统级别的不会出现被杀死而无法推送的情况。
- 省电，不会出现每个应用都各自维护一个自己的长连接。　
- 安全，只有在苹果注册的开发者才能够进行推送，等等。　


# 推送的实现步骤
1. 由App向iOS设备发送一个注册通知，用户需要同意系统发送推送。
2. iOS向APNs远程推送服务器发送App的Bundle Id和设备的UDID。
3. APNs根据设备的UDID和App的Bundle Id生成deviceToken再发回给App。
4. App再将deviceToken发送给远程推送服务器(自己的服务器), 由服务器保存在数据库中。
5. 当自己的服务器想发送推送时, 在远程推送服务器中输入要发送的消息并选择发给哪些用户的deviceToken，由远程推送服务器发送给APNs。
6. APNs根据deviceToken发送给对应的用户。

# 其他要点

- APNs 服务器就是苹果专门做远程推送的服务器。
- deviceToken是由APNs生成的一个专门找到你某个手机上的App的一个标识码。
- deviceToken 可能会变,如果你更改了你项目的bundle Identifier或者APNs服务器更新了可能会变。
- 在app卸载重装之后，deviceToken也会发生变化。可以把保存在钥匙串的UUID跟deviceToken一起上传到后台服务器，后台根据唯一ID判断如果是同一设备deviceToken更新了，就用最新的替换掉之前的。

